const cds = require('../../../../cds')
const { SELECT } = cds.ql

const { getDeepSelect } = require('../../../services/utils/handlerUtils')
const { DRAFT_COLUMNS } = require('../../../../common/constants/draft')

const _getColumns = target =>
  Object.keys(target.elements).filter(
    k => !target.elements[k].isAssociation && !target.elements[k].virtual && !DRAFT_COLUMNS.includes(k) // > getDeepSelect() does the same
  )

module.exports = (req, srv) => {
  if (req.event === 'draftActivate') {
    const where = Object.keys(req.target.keys)
      .filter(k => k !== 'IsActiveEntity')
      .reduce((w, k) => {
        w[k] = req.data[k]
        return w
      }, {})
    return cds.tx(req).run(SELECT.from(req.target).columns(_getColumns(req.target)).where(where))
  }

  if (req.event === 'UPDATE') {
    return cds.tx(req).run(SELECT.from(req.query.UPDATE.entity, _getColumns(req.target)))
  }

  return cds.tx(req).run(getDeepSelect(req, srv.model.definitions))
}
