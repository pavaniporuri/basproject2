const https = require('https')

const requestToken = ({ client, secret, endpoint }, msgSrv) =>
  new Promise((resolve, reject) => {
    const options = {
      host: endpoint.replace('/oauth/token', '').replace('https://', ''),
      path: '/oauth/token?grant_type=client_credentials&response_type=token',
      headers: {
        Authorization: 'Basic ' + Buffer.from(client + ':' + secret).toString('base64')
      }
    }

    https.get(options, res => {
      res.setEncoding('utf8')
      let result = ''
      res.on('data', chunk => {
        result += chunk
      })
      res.on('end', () => {
        const json = JSON.parse(result)
        if (!json.access_token) {
          reject(new Error('Authorization failed'))
        }
        // store token on msgSrv
        msgSrv.token = json.access_token
        resolve(json.access_token)
      })
    })
  })

module.exports = requestToken
