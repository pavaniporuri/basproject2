const cds = require('../cds')

class Composite extends cds.Service {
  async init() {
    const _globToRegExp = string =>
      string &&
      string
        .replace(/\*\*/g, '.<stars>')
        .replace(/\*/g, '[^/]*')
        .replace(/\?/g, '.')
        .replace(/<stars>/g, '*')
    const { routes } = this.options
    const keys = routes ? Object.keys(routes) : []
    const services = await Promise.all(keys.map(each => cds.connect.to(each)))
    const channels = keys.map(each =>
      routes[each].map(route => {
        if (typeof route === 'string') return { event: _globToRegExp(route) }
        if (typeof route === 'object') return { event: _globToRegExp(route.event), entity: _globToRegExp(route.entity) }
      })
    )

    // TODO: Match entity
    this._foreach = (event, callback) =>
      channels.map((each, i) => {
        for (const route of each) {
          if (event.match(route.event)) {
            return callback(services[i])
          }
        }
      })
  }

  on(event, handler) {
    if (Array.isArray(event)) event.map(e => this.on(e, handler))
    else this._foreach(event, srv => srv.on(event, handler))
  }

  dispatch(eve, ...etc) {
    return Promise.all(this._foreach(eve.event, srv => srv.dispatch(eve, ...etc)))
  }
}
module.exports = Composite
