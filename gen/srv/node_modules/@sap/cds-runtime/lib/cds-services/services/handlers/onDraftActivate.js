const cds = require('../../../cds')
const { UPDATE, INSERT, DELETE } = cds.ql

const { ensureNoDraftsSuffix, ensureDraftsSuffix } = require('../utils/draftUtils')
const { readAndDeleteKeywords, isActiveEntityRequested } = require('../utils/draftWhereUtils')
const { readDraftCompositionTree } = require('../utils/readDraftCompositionTree')
const { isDraftRootEntity } = require('../utils/compositionTree')
const _isLocked = (InProcessByUser, id) => InProcessByUser && InProcessByUser !== id

const _getDeleteDraftAdminCqn = draftUUID =>
  DELETE.from('DRAFT.DraftAdministrativeData').where([{ ref: ['DraftUUID'] }, '=', { val: draftUUID }])

const _getDeleteRootDraftCqn = (targetName, rootWhere) => DELETE.from(targetName).where(rootWhere)

/**
 * Generic Handler for draftActivate requests.
 * In case of success it triggers an 'UPDATE' or 'CREATE' event.
 */
const _handler = async function (req) {
  if (
    isActiveEntityRequested(req.query.SELECT.from.ref[0].where || []) ||
    req.query.SELECT.from.ref.length > 2 ||
    !isDraftRootEntity(this.model.definitions, ensureNoDraftsSuffix(req.target.name))
  ) {
    req.reject(400)
  }

  const { draftData, activeData, adminData } = await readDraftCompositionTree(this, req)

  if (!draftData) {
    req.reject(404)
  }

  if (_isLocked(adminData.InProcessByUser, req.user.id)) {
    req.reject(403)
  }

  const deleteDraftAdminCqn = _getDeleteDraftAdminCqn(adminData.DraftUUID)
  const deleteRootDraftCqn = _getDeleteRootDraftCqn(
    ensureDraftsSuffix(req.target.name),
    req.query.SELECT.from.ref[0].where
  )

  const dbtx = cds.tx(req)

  await Promise.all([dbtx.run(deleteDraftAdminCqn), dbtx.run(deleteRootDraftCqn)])

  let query, event
  if (activeData) {
    readAndDeleteKeywords(['IsActiveEntity'], req.query.SELECT.from.ref[0].where)
    event = 'UPDATE'
    // REVSIIT: setting data should be part of ql
    query = UPDATE(req.target).where(req.query.SELECT.from.ref[0].where)
    query.UPDATE.data = draftData
    query._activeData = activeData
  } else {
    event = 'CREATE'
    query = INSERT.into(req.target).entries(draftData)
  }

  // REVISIT: _draftMetadata
  const r = new cds.Request({ event, query, data: draftData, _draftMetadata: adminData })

  // REVISIT: should not be necessary
  r._ = Object.assign(r._, req._)
  r.getUriInfo = () => req.getUriInfo()
  r.getUrlObject = () => req.getUrlObject()
  r._.params = req.params

  const result = await this.dispatch(r)

  // REVISIT: should not be necessary
  if (r.messages) for (const m of r.messages) req.info(m)

  return result
}

// REVISIT: draftActivate -> ACTIVATE

const { ODATA, COMMON } = require('../../../common/constants/annotation')
const _relevant = e => e[ODATA.DRAFT] || e[COMMON.DRAFT_NODE.PREP_ACTION]

module.exports = function () {
  for (const entity of Object.values(this.entities).filter(_relevant)) {
    this.on('draftActivate', entity, _handler)
  }
}
