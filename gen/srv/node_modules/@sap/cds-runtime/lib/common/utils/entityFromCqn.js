const { ensureNoDraftsSuffix } = require('../../common/utils/draft')

const _entityFromRef = ref => {
  if (ref) return ref[0].id || ref[0]
}

const getEntityNameFromCQN = cqn => {
  while (cqn.SELECT) {
    cqn = cqn.SELECT.from
  }

  return _getEntityNameFromUnionCQN(cqn) || _entityFromRef(cqn.ref)
}

const _getEntityNameFromUnionCQN = cqn => {
  // TODO cleanup
  // REVISIT infer should do this for req.target
  if (cqn.SET) {
    return cqn.SET.args
      .map(arg => {
        return getEntityNameFromCQN(arg)
      })
      .filter(name => {
        return name !== 'DRAFT.DraftAdministrativeData'
      })[0]
  }
  if (cqn.join) {
    return cqn.args
      .map(arg => {
        return getEntityNameFromCQN(arg)
      })
      .filter(name => {
        return !name.endsWith('_drafts')
      })[0]
  }
}

const getEntityFromCQN = (req, service) => {
  return req.target._unresolved
    ? service.model.definitions[ensureNoDraftsSuffix(getEntityNameFromCQN(req.query))]
    : req.target
}

module.exports = {
  getEntityFromCQN,
  getEntityNameFromCQN
}
